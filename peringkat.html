<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Peringkat Nilai</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#f8fafc; --primary:#0d6efd; }
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background:#fafafa; }
    h1 { text-align:center; margin: 0 0 16px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin: 8px 0 8px; gap:12px; }
    .btn { padding:10px 14px; border:none; background:var(--primary); color:#fff; font-weight:bold; border-radius:8px; cursor:pointer; }
    .btn:disabled { opacity:.7; cursor:not-allowed; }
    .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px; }

    /* --- kotak pencarian --- */
    .search-row {
      margin: 0 0 12px;
    }
    .search-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      box-sizing: border-box;
    }

    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td { padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; }
    th { background:#f3f4f6; }

    .col-no   { width:20px; }         /* kecil */
    .col-main { width:auto; }         /* lebar */
    .col-stat { width:40px; }        /* kecil */

    /* isi 2-baris dalam satu sel */
    .cell { display:flex; flex-direction:column; gap:4px; }
    .top  { font-size:15px; line-height:1.1; }
    .sub  { font-size:13px; color:#555; line-height:1.1; }  /* lebih kecil */
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    /* No hanya tampil di baris-atas; kita sembunyikan 'sub' di kolom No */
    .no .sub { visibility:hidden; height:0; padding:0; margin:0; }

    @media (max-width: 400px) {
      .col-no{ width:20px; }
      .col-stat{ width:40px; }
    }
  </style>
</head>
<body>

<h1>Peringkat</h1>

<div class="toolbar">
  <div class="muted" id="lastUpdate">â€”</div>
  <button class="btn" id="btnReload" onclick="loadData()">Muat Ulang</button>
</div>

<!-- KOTAK PENCARIAN: DI BAWAH TOMBOL, DI ATAS TABEL -->
<div class="search-row">
  <input
    type="text"
    id="searchBox"
    class="search-input"
    placeholder="Cari berdasarkan peringkat, kelas, nama, nilai, atau durasi..."
  />
</div>

<div class="card">
  <div id="container"></div>
</div>

<script>
// ====== CONFIG ======
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz9aJHtdRfpUGOr9yW_O49QHLfFTvxboQm9jNrOhw6SpSzfQHm05xCHJz7wzjUEBlOlnQ/exec"; // ex: https://script.google.com/macros/s/AKfycb.../exec
const API_TOKEN   = "soal2";

// simpan semua data asli untuk keperluan filter
let ALL_ROWS = [];

// ====== API ======
async function apiGet(fn) {
  const base = (WEB_APP_URL || "").trim();
  if (!/^https?:\/\//i.test(base)) throw new Error("WEB_APP_URL tidak valid.");
  const u = new URL(base);
  u.searchParams.set("fn", fn);
  if (API_TOKEN) u.searchParams.set("token", API_TOKEN);
  const r = await fetch(u.toString(), { method: "GET" });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ====== Utils ======
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function pad2(n){ return n<10 ? "0"+n : String(n); }
function parseDurasiToSec(txt){
  if (!txt) return null;
  const t = String(txt).trim().toLowerCase();
  const m = t.match(/(\d+)\s*menit/);
  const s = t.match(/(\d+)\s*detik/);
  if (m || s) { const mm=m?parseInt(m[1],10):0; const ss=s?parseInt(s[1],10):0; return mm*60+ss; }
  const p = t.split(':').map(x=>parseInt(x,10));
  if (p.some(isNaN)) return null;
  return p.length===3 ? p[0]*3600+p[1]*60+p[2] : p.length===2 ? p[0]*60+p[1] : null;
}
function toMMSS(txt){
  const sec = parseDurasiToSec(txt);
  if (sec==null) return "--:--";
  const mm = Math.floor(sec/60), ss = sec%60;
  return `${pad2(mm)}:${pad2(ss)}`;
}

// ====== UI ======
async function loadData() {
  const btn = document.getElementById('btnReload');
  btn.disabled = true; btn.textContent = 'Memuat...';
  try {
    const res = await apiGet("peringkat");
    const rows = (res && res.ok && Array.isArray(res.rows)) ? res.rows : [];
    ALL_ROWS = rows;              // simpan data asli
    applyFilter();                // render berdasarkan isi kotak pencarian saat ini
    document.getElementById('lastUpdate').textContent = 'Terakhir diperbarui: ' + new Date().toLocaleString();
  } catch (err) {
    alert('Gagal memuat peringkat: ' + err.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Muat Ulang';
  }
}

// Filter berdasarkan semua kolom
function applyFilter() {
  const hostInput = document.getElementById('searchBox');
  const q = (hostInput ? hostInput.value : '').trim().toLowerCase();

  if (!ALL_ROWS.length) {
    renderTable([]);
    return;
  }

  if (!q) {
    // jika kosong, tampilkan semua
    renderTable(ALL_ROWS);
    return;
  }

  const filtered = ALL_ROWS.filter(r => {
    const values = [
      r.peringkat,
      r.kelas,
      r.nama,
      r.nilai,
      r.durasi,
      toMMSS(r.durasi)
    ].map(v => (v == null ? '' : String(v).toLowerCase()));

    return values.some(v => v.includes(q));
  });

  renderTable(filtered);
}

function renderTable(rows){
  const host = document.getElementById('container');
  if (!rows.length) {
    host.innerHTML = '<div class="empty">Belum ada data peringkat atau tidak ada hasil untuk pencarian ini.</div>';
    return;
  }

  const tbl = document.createElement('table');

  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th class="col-no">No</th>
      <th class="col-main">Nama</th>
      <th class="col-stat">Nilai</th>
    </tr>`;
  tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(r => {
    const mmss = toMMSS(r.durasi);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-no">
        <div class="cell no">
          <div class="top mono">${r.peringkat}</div>
          <div class="sub mono">.</div>
        </div>
      </td>
      <td class="col-main">
        <div class="cell">
          <div class="top">${escapeHtml(r.kelas).replace(/\b\w/g, c=>c.toUpperCase())}</div>
          <div class="sub">${escapeHtml(r.nama)}</div>
        </div>
      </td>
      <td class="col-stat">
        <div class="cell">
          <div class="top mono">${r.nilai}</div>
          <div class="sub mono">${mmss}</div>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  host.innerHTML = '';
  host.appendChild(tbl);
}

// event pencarian real-time
document.getElementById('searchBox').addEventListener('input', applyFilter);

// load awal
loadData();
</script>
</body>
</html>
