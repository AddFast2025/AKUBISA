<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Peringkat Nilai (Self-hosted)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --border:#e5e7eb; --muted:#f8fafc; --primary:#0d6efd; }
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background:#fafafa; }
    h1 { text-align:center; margin: 0 0 16px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; margin: 8px 0 16px; gap:12px; }
    .btn { padding:10px 14px; border:none; background:var(--primary); color:#fff; font-weight:bold; border-radius:8px; cursor:pointer; }
    .btn:disabled { opacity: .7; cursor:not-allowed; }
    .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:14px; }
    table { width:100%; border-collapse:collapse; table-layout: fixed; }
    th, td { padding:10px; border-bottom:1px solid var(--border); text-align:left; }
    th { background:#f3f4f6; }
    tr:hover td { background:#fafafa; }

    /* 3 kolom */
    .col-no   { width: 60px; }
    .col-main { width: auto; }
    .col-stat { width: 160px; }

    .muted { color:#555; font-size: 13px; }
    .empty { text-align:center; padding:20px; color:#666; white-space:nowrap; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    @media (max-width: 640px) {
      .col-no   { width: 56px; }
      .col-stat { width: 140px; }
    }
  </style>
</head>
<body>

<h1>Peringkat</h1>

<div class="toolbar">
  <div class="muted" id="lastUpdate">â€”</div>
  <button class="btn" id="btnReload" onclick="loadData()">Muat Ulang</button>
</div>

<div class="card">
  <div id="container"></div>
</div>

<script>
// ====== CONFIG ======
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz9aJHtdRfpUGOr9yW_O49QHLfFTvxboQm9jNrOhw6SpSzfQHm05xCHJz7wzjUEBlOlnQ/exec"; // ex: https://script.google.com/macros/s/AKfycb.../exec
const API_TOKEN   = "soal2";                  // samakan dgn Code.gs

// ====== API helper ======
async function apiGet(fn) {
  const base = (WEB_APP_URL || "").trim();
  if (!/^https?:\/\//i.test(base)) throw new Error("WEB_APP_URL tidak valid.");
  const u = new URL(base);
  u.searchParams.set("fn", fn);
  if (API_TOKEN) u.searchParams.set("token", API_TOKEN);
  const r = await fetch(u.toString(), { method: "GET" });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ====== Utils ======
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function pad2(n){ return n < 10 ? "0"+n : String(n); }

// terima "x menit y detik" / "mm:ss" / "hh:mm:ss"
function parseDurasiToSec(txt){
  if (!txt) return null;
  const t = String(txt).trim().toLowerCase();

  const m = t.match(/(\d+)\s*menit/);
  const s = t.match(/(\d+)\s*detik/);
  if (m || s) {
    const mm = m ? parseInt(m[1],10) : 0;
    const ss = s ? parseInt(s[1],10) : 0;
    return (isNaN(mm)||isNaN(ss)) ? null : (mm*60+ss);
  }

  const parts = t.split(':').map(x => parseInt(x,10));
  if (parts.some(isNaN)) return null;
  if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
  if (parts.length === 2) return parts[0]*60 + parts[1];
  return null;
}
function formatMMSS(txt){
  const sec = parseDurasiToSec(txt);
  if (sec == null) return "--:--";
  const mm = Math.floor(sec/60);
  const ss = sec % 60;
  return `${pad2(mm)}:${pad2(ss)}`;
}

// ====== UI logic ======
async function loadData() {
  const btn = document.getElementById('btnReload');
  btn.disabled = true; btn.textContent = 'Memuat...';
  try {
    const res = await apiGet("peringkat");
    const rows = (res && res.ok && Array.isArray(res.rows)) ? res.rows : [];
    renderTable(rows);
    document.getElementById('lastUpdate').textContent =
      'Terakhir diperbarui: ' + new Date().toLocaleString();
  } catch (err) {
    alert('Gagal memuat peringkat: ' + err.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Muat Ulang';
  }
}

function renderTable(rows){
  const host = document.getElementById('container');
  if (!rows.length) {
    host.innerHTML = '<div class="empty">Belum ada data peringkat.</div>';
    return;
  }

  const tbl = document.createElement('table');

  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th class="col-no">No</th>
      <th class="col-main">Kelas - Nama</th>
      <th class="col-stat">Nilai - Durasi</th>
    </tr>
  `;
  tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(r => {
    const kelasNama = `${escapeHtml(r.kelas)} - ${escapeHtml(r.nama)}`;
    const mmss = formatMMSS(r.durasi);
    const nilaiDur = `<span class="mono">${r.nilai}</span> - <span class="mono">${mmss}</span>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-no">${r.peringkat}</td>
      <td class="col-main">${kelasNama}</td>
      <td class="col-stat">${nilaiDur}</td>
    `;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  host.innerHTML = '';
  host.appendChild(tbl);
}

// auto-load
loadData();
</script>
</body>
</html>
